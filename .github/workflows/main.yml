name: NCP 3-Tier CI/CD Pipeline (Self-Hosted)

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
    - name: 1. 깃허브 로봇 작업실로 최신 코드 다운로드
      uses: actions/checkout@v3

    - name: 2. WAS 서버 코드로 덮어쓰고 서버 재시작
      run: |
        # 1. 다운받은 코드를 실제 서버 폴더로 덮어쓰기
        cp -rf was-server/* /root/my-board-server/
        
        # 2. 서버 폴더로 이동해서 패키지 설치
        cd /root/my-board-server
        npm install
        
        # 3. [핵심] PM2가 기존 실행 목록을 찾을 수 있도록 HOME 환경변수 강제 주입!
        export HOME=/root
        
        # 4. 서버 재시작 (목록에 없으면 새로 시작해라!)
        pm2 restart server.js || pm2 start server.js
